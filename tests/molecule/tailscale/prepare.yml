---
- name: Prepare
  hosts: all
  become: yes
  gather_facts: yes

  tasks:
    - name: Check macOS version
      ansible.builtin.debug:
        msg: "Running on macOS {{ ansible_distribution_version }}"

    - name: Check if running as root
      ansible.builtin.fail:
        msg: "This test must be run with sudo/administrative privileges"
      when: ansible_user_uid != 0

    - name: Ensure /usr/local/bin exists
      ansible.builtin.file:
        path: /usr/local/bin
        state: directory
        mode: '0755'

    - name: Clean up any existing Tailscale installation
      ansible.builtin.include_tasks:
        file: ../destroy.yml
      when: cleanup_existing | default(false)

    - name: Display test preparation completion
      ansible.builtin.debug:
        msg: "Test preparation completed"