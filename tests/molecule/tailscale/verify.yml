---
- name: Verify
  hosts: all
  become: yes
  gather_facts: yes
  collections:
    - kaitranntt.mac

  tasks:
    - name: Check if Tailscale CLI is installed
      ansible.builtin.stat:
        path: /usr/local/bin/tailscale
      register: tailscale_cli
      failed_when: not tailscale_cli.stat.exists

    - name: Check if Tailscaled is installed
      ansible.builtin.stat:
        path: /usr/local/bin/tailscaled
      register: tailscaled_cli
      failed_when: not tailscaled_cli.stat.exists

    - name: Check Tailscale version
      ansible.builtin.command: /usr/local/bin/tailscale version
      register: tailscale_version
      changed_when: false

    - name: Display Tailscale version
      ansible.builtin.debug:
        var: tailscale_version.stdout_lines

    - name: Check if LaunchDaemon is loaded
      ansible.builtin.command: launchctl list | grep com.tailscale.tailscaled
      register: tailscale_service
      changed_when: false
      failed_when: false

    - name: Verify service is running
      ansible.builtin.assert:
        that:
          - tailscale_service.rc == 0
        fail_msg: "Tailscale service is not running"
        success_msg: "Tailscale service is running"

    - name: Check Tailscale socket
      ansible.builtin.stat:
        path: /var/run/tailscale/tailscaled.sock
      register: tailscale_socket
      failed_when: not tailscale_socket.stat.exists

    - name: Check Tailscale status
      ansible.builtin.command: /usr/local/bin/tailscale status
      register: tailscale_status
      changed_when: false
      failed_when: false

    - name: Display Tailscale status
      ansible.builtin.debug:
        var: tailscale_status.stdout_lines

    - name: Verify Tailscale is functional
      ansible.builtin.assert:
        that:
          - tailscale_status.rc == 0
        fail_msg: "Tailscale is not responding to status command"
        success_msg: "Tailscale is responding correctly"